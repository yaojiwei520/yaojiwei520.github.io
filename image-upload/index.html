<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub图床 - 免Token自动上传</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { background-color: #f0f2f5; }
        .container { max-width: 800px; }
        .upload-area {
            border: 3px dashed #6c757d;
            background-color: #ffffff;
            border-radius: 15px;
            transition: all 0.3s ease-in-out;
            cursor: pointer;
        }
        .upload-area:hover {
            border-color: #0d6efd;
            background-color: #e9f0ff;
            box-shadow: 0 4px 15px rgba(0, 100, 255, 0.1);
        }
        /* 批量预览区域样式 */
        #previewContainer {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }
        .image-preview-item {
            position: relative;
            width: 150px;
            height: 150px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background-color: #eee;
            display: flex;
            flex-direction: column; /* 垂直排列内容 */
            align-items: center;
            justify-content: center; /* 垂直居中 */
            text-align: center;
            font-size: 0.8em;
            color: #666;
            word-break: break-all;
            padding: 5px; /* 添加内边距 */
            box-sizing: border-box; /* 边框和内边距包含在宽度内 */
        }
        .image-preview-item img {
            max-width: 100%;
            max-height: 80%; /* 留出空间给文件名 */
            object-fit: contain;
            /* margin-bottom: 5px; */ /* 图片和文件名之间加点间距 */
        }
        .image-preview-item .file-name {
            display: block;
            width: 100%; /* 确保占据完整宽度 */
            overflow: hidden; /* 隐藏溢出内容 */
            white-space: nowrap; /* 不换行 */
            text-overflow: ellipsis; /* 显示省略号 */
            font-size: 0.75em;
            margin-top: 5px;
        }
        .image-preview-item .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(220, 53, 69, 0.8);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.8em;
            line-height: 1;
            padding: 0;
            border: none;
            transition: background-color 0.2s;
        }
        .image-preview-item .remove-btn:hover {
            background-color: rgba(220, 53, 69, 1.0);
        }

        .progress {
            height: 25px;
            display: none;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
        .card {
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        .card-header {
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
        }
        .alert {
            border-radius: 10px;
        }
        #resultLinksGroup .list-group-item {
            word-break: break-all;
            white-space: normal;
        }
    </style>
</head>
<body>
    <div class="container py-5">
        <div class="text-center mb-5">
            <h1><i class="fas fa-cloud-upload-alt me-2"></i>GitHub图床上传工具</h1>
            <p class="text-muted">拖拽图片到下方区域或点击选择文件</p>
        </div>

        <div class="upload-area p-5 text-center mb-4" id="dropZone">
            <i class="fas fa-images fa-4x mb-3 text-muted"></i>
            <p class="fs-5">将图片拖到此处或点击上传</p>
            <input type="file" id="fileInput" accept="image/jpeg, image/png, image/gif, image/webp" class="d-none" multiple>
        </div>
        
        <!-- 全局上传进度条 -->
        <div class="progress mb-3" id="uploadProgress">
            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                 role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
        </div>

        <div class="card mb-3" id="previewCard" style="display: none;">
            <div class="card-body">
                <h5 class="card-title text-center mb-3">图片预览 (<span id="fileCount">0</span> 张)</h5>
                <div id="previewContainer" class="mb-3">
                    <!-- 图片预览将在此处动态生成 -->
                </div>
                <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                    <button class="btn btn-danger me-md-2" id="cancelBtn">
                        <i class="fas fa-times me-1"></i>取消上传
                    </button>
                    <button class="btn btn-success" id="confirmBtn" disabled>
                        <i class="fas fa-check me-1"></i>确认上传
                    </button>
                </div>
            </div>
        </div>

        <div class="card" id="resultCard" style="display: none;">
            <div class="card-header bg-success text-white">
                <i class="fas fa-check-circle me-1"></i>上传成功
            </div>
            <div class="card-body">
                <p class="text-success mb-2">图片已成功上传并发布！</p>
                <div id="resultLinksGroup" class="list-group mb-3">
                    <!-- 上传成功的链接将在此处动态生成 -->
                </div>
                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle me-1"></i>
                    图片通常在几秒内即可访问，由于CDN缓存可能存在短暂延迟。
                </div>
                <button class="btn btn-primary mt-3" id="uploadAnotherBtn">
                    <i class="fas fa-upload me-1"></i> 继续上传
                </button>
            </div>
        </div>
    </div>

    <!-- FontAwesome for icons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // DOM元素
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const previewContainer = document.getElementById('previewContainer'); 
        const fileCountSpan = document.getElementById('fileCount'); 
        const previewCard = document.getElementById('previewCard');
        const progressBar = document.querySelector('.progress-bar');
        const uploadProgress = document.getElementById('uploadProgress');
        const resultCard = document.getElementById('resultCard');
        const resultLinksGroup = document.getElementById('resultLinksGroup'); 
        const confirmBtn = document.getElementById('confirmBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const uploadAnotherBtn = document.getElementById('uploadAnotherBtn');

        // 全局变量
        let filesToUpload = []; // 存储待上传的文件对象
        let uploadInProgress = false;
        let mainAbortController = null; // 主要的 AbortController，用于控制所有请求

        const UPLOAD_API_URL = 'https://github-image-uploader-backend.vercel.app/api/upload'; 
        const PROXY_PREFIX = 'https://gh.catmak.name/'; 

        // --- UI 状态管理函数 ---
        function resetUI() {
            filesToUpload = []; // 重置文件列表
            previewContainer.innerHTML = ''; // 清空预览
            fileCountSpan.textContent = '0';
            previewCard.style.display = 'none';
            uploadProgress.style.display = 'none';
            resultCard.style.display = 'none';
            resultLinksGroup.innerHTML = ''; // 清空结果链接
            progressBar.style.width = '0%';
            progressBar.classList.remove('bg-success', 'bg-danger');
            confirmBtn.disabled = true;
            fileInput.value = ''; 
            dropZone.style.display = 'block'; 
            mainAbortController = null; // 重置 AbortController
        }

        function showUploadProgress(currentFileIndex = 0, totalFiles = 1) {
            dropZone.style.display = 'none';
            previewCard.style.display = 'none';
            resultCard.style.display = 'none';
            uploadProgress.style.display = 'block';
            // 显示整体上传进度，例如 1/N
            const percentCompleted = totalFiles > 0 ? Math.round(((currentFileIndex + 1) / totalFiles) * 100) : 0; // 这里的 +1 是为了显示当前文件完成后
            progressBar.style.width = `${percentCompleted}%`;
            progressBar.setAttribute('aria-valuenow', percentCompleted);
            progressBar.classList.remove('bg-success', 'bg-danger');
            progressBar.classList.add('progress-bar-animated'); 
            uploadInProgress = true;
            confirmBtn.disabled = true; 
            cancelBtn.textContent = '取消上传'; 
        }

        function showPreview() {
            dropZone.style.display = 'block'; 
            previewCard.style.display = 'block';
            uploadProgress.style.display = 'none';
            resultCard.style.display = 'none';
            confirmBtn.disabled = filesToUpload.length === 0; 
            uploadInProgress = false; 
            cancelBtn.textContent = '取消选择'; 
            fileCountSpan.textContent = filesToUpload.length; 
        }

        function showResult(uploadedResults) {
            uploadProgress.style.display = 'none';
            previewCard.style.display = 'none';
            resultCard.style.display = 'block';
            resultLinksGroup.innerHTML = ''; 

            uploadedResults.forEach(result => {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                
                const originalFileName = result.originalFileName; 
                const blobUrl = result.blobUrl;
                const cdnUrl = result.cdnUrl;

                const proxiedBlobUrl = PROXY_PREFIX + blobUrl;
                const proxiedCdnUrl = PROXY_PREFIX + cdnUrl;
                const markdownCode = `![image](${proxiedCdnUrl})`;

                li.innerHTML = `
                    <h6><strong>${originalFileName}</strong></h6>
                    <small class="text-muted">直接链接 (Blob):</small><br>
                    <div class="input-group input-group-sm mb-2">
                        <input type="text" class="form-control" value="${proxiedBlobUrl}" readonly>
                        <button class="btn btn-outline-secondary copy-btn" data-copy-target="${proxiedBlobUrl}">复制</button>
                    </div>
                    <small class="text-muted">Markdown (CDN):</small><br>
                    <div class="input-group input-group-sm">
                        <input type="text" class="form-control" value="${markdownCode}" readonly>
                        <button class="btn btn-outline-secondary copy-btn" data-copy-target="${markdownCode}">复制</button>
                    </div>
                `;
                resultLinksGroup.appendChild(li);
            });
            
            resultLinksGroup.querySelectorAll('.copy-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const textToCopy = e.currentTarget.dataset.copyTarget;
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        alert('链接已复制到剪贴板！');
                    }).catch(err => {
                        console.error('复制失败:', err);
                        alert('复制失败，请手动复制。');
                    });
                });
            });

            progressBar.classList.add('bg-success'); 
            progressBar.style.width = '100%';
            progressBar.classList.remove('progress-bar-animated');
            uploadInProgress = false;
        }

        function showError(message) {
            uploadProgress.style.display = 'block'; 
            progressBar.classList.add('bg-danger');
            progressBar.style.width = '100%';
            progressBar.classList.remove('progress-bar-animated');
            alert(`上传失败: ${message}`);
            uploadInProgress = false;
            // setTimeout(resetUI, 3000); // 暂时不自动重置，让用户看到错误
        }

        // --- 文件处理 ---
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#0d6efd';
            dropZone.style.backgroundColor = '#e9f0ff';
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.style.borderColor = '#6c757d';
            dropZone.style.backgroundColor = '';
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#6c757d';
            dropZone.style.backgroundColor = '';

            handleFiles(e.dataTransfer.files); 
        });

        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', () => {
            handleFiles(fileInput.files); 
        });

        function handleFiles(files) {
            if (uploadInProgress) return; 

            const newFiles = Array.from(files);

            newFiles.forEach(file => {
                const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
                if (!validTypes.includes(file.type)) {
                    alert(`文件 "${file.name}" 格式不支持，仅支持 JPG/PNG/GIF/WEBP。已跳过。`);
                    return;
                }
                const MAX_FILE_SIZE = 5 * 1024 * 1024;
                if (file.size > MAX_FILE_SIZE) {
                    alert(`文件 "${file.name}" 大小超过5MB。已跳过。`);
                    return;
                }
                filesToUpload.push(file);
            });
            
            updatePreview(); 
        }

        function updatePreview() {
            previewContainer.innerHTML = ''; 
            if (filesToUpload.length === 0) {
                showPreview(); 
                return;
            }

            // 重新为每个文件生成预览，并更新索引
            filesToUpload.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const item = document.createElement('div');
                    item.className = 'image-preview-item';
                    
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.alt = file.name;

                    const fileNameSpan = document.createElement('span');
                    fileNameSpan.className = 'file-name';
                    fileNameSpan.textContent = file.name;

                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'remove-btn';
                    removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                    removeBtn.addEventListener('click', () => removeFile(index)); // 传递当前索引

                    item.appendChild(img);
                    item.appendChild(fileNameSpan); 
                    item.appendChild(removeBtn);
                    previewContainer.appendChild(item);
                };
                reader.readAsDataURL(file);
            });
            showPreview(); 
        }

        function removeFile(indexToRemove) {
            filesToUpload = filesToUpload.filter((_, index) => index !== indexToRemove);
            updatePreview(); // 重新渲染预览
        }

        // --- 上传逻辑 ---
        async function uploadFileIndividualy(file, fileIndex, totalFiles) {
            // 为每个文件创建独立的 Promise 包装器
            return new Promise(async (resolve, reject) => {
                if (!mainAbortController || mainAbortController.signal.aborted) {
                    console.log("Upload aborted before starting file:", file.name);
                    return reject(new Error('Upload aborted'));
                }

                const reader = new FileReader();
                reader.readAsDataURL(file);

                reader.onloadend = async () => {
                    if (mainAbortController.signal.aborted) {
                        return reject(new Error('Upload aborted during file read'));
                    }
                    const base64Image = reader.result.split(',')[1];
                    const fileType = file.type;

                    const MAX_RETRIES = 3;
                    let retries = 0;
                    
                    while (retries < MAX_RETRIES) {
                        try {
                            if (mainAbortController.signal.aborted) {
                                return reject(new Error('Upload aborted during retry wait'));
                            }
                            const response = await axios.post(
                                UPLOAD_API_URL, 
                                {
                                    image: base64Image,
                                    type: fileType
                                },
                                {
                                    signal: mainAbortController.signal, // 使用主 AbortController 的信号
                                    onUploadProgress: (progressEvent) => { 
                                        // 这里可以用于更细致的单文件进度条，但目前我们只更新总体进度
                                    }
                                }
                            );
                            resolve({ ...response.data, originalFileName: file.name }); // 返回成功数据
                            return; // 成功后退出重试循环
                            
                        } catch (error) {
                            if (axios.isCancel(error)) { // 被取消
                                console.log(`文件 "${file.name}" 上传已取消.`);
                                return reject(new Error('Upload cancelled'));
                            }

                            retries++;
                            console.error(`文件 "${file.name}" 上传失败 (尝试 ${retries}/${MAX_RETRIES}):`, error.response ? error.response.data : error.message);
                            if (retries < MAX_RETRIES) {
                                const delay = Math.pow(2, retries) * 1000 + Math.random() * 500;
                                await new Promise(res => setTimeout(res, delay)); // 等待后重试
                            } else {
                                // 所有重试都失败
                                return reject(new Error(`文件 "${file.name}" 上传失败: ${error.response?.data?.error || error.message || '未知错误'}`));
                            }
                        }
                    }
                };
                reader.onerror = () => {
                    showError(`读取文件 "${file.name}" 失败。`);
                    reject(new Error('File read error'));
                };
            });
        }


        async function startUpload() {
            if (filesToUpload.length === 0 || uploadInProgress) return;

            uploadInProgress = true;
            confirmBtn.disabled = true;
            cancelBtn.textContent = '取消上传'; 
            mainAbortController = new AbortController(); // 为本次批量上传创建新的控制器

            const UploadedResults = []; // 存储所有成功上传的结果
            let failedCount = 0;

            for (let i = 0; i < filesToUpload.length; i++) {
                const file = filesToUpload[i];
                showUploadProgress(i, filesToUpload.length); // 更新总体进度条: 当前处理第i个文件

                try {
                    const result = await uploadFileIndividualy(file, i, filesToUpload.length);
                    UploadedResults.push(result);
                } catch (error) {
                    console.error(`处理文件 "${file.name}" 失败:`, error.message);
                    failedCount++;
                    // 如果被取消，中断整个循环
                    if (mainAbortController.signal.aborted) {
                        break;
                    }
                }

                if (mainAbortController.signal.aborted) { // 再次检查是否被取消
                    console.log("Batch upload fully aborted by user.");
                    break; 
                }
            }

            uploadInProgress = false;
            confirmBtn.disabled = false; // 上传完成或取消后重新启用按钮
            cancelBtn.textContent = '取消选择'; // 恢复取消选择按钮文本

            if (mainAbortController.signal.aborted) {
                showError('所有上传操作已取消。');
                resetUI(); // 取消后重置UI
            } else if (UploadedResults.length > 0) {
                showResult(UploadedResults); // 显示所有成功的结果
                if (failedCount > 0) {
                    alert(`注意：有 ${failedCount} 个文件上传失败，其余已成功。`);
                }
            } else {
                showError('所有文件上传失败或被取消，请重试。');
                resetUI(); // 没有成功文件，重置UI
            }
        }

        // --- 辅助函数 ---
        // copyUrl 和 copyMarkdown 函数现在不再直接与 input 绑定，而是通过事件委托实现
        // 现已修改 showResult 中直接复制 textContent 的方式

        // --- 按钮事件 ---
        confirmBtn.addEventListener('click', startUpload);
        cancelBtn.addEventListener('click', () => {
            if (uploadInProgress && mainAbortController) {
                mainAbortController.abort(); // 触发 AbortController 中断所有请求
            } else {
                resetUI(); 
            }
        });
        uploadAnotherBtn.addEventListener('click', resetUI);

        // 初始化UI
        resetUI();
    </script>
</body>
</html>
